{% extends "cis/logged-base.html" %}
{%block title %}{{ page_title }}{% endblock %}

{% load templatehelpers %}
{% load crispy_forms_tags %}

{% block body %}
<main>

    <div class="row">
        
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href='/ce/invoices/' >All Invoices</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">Invoice</li>
                </ol>
            </nav>
        </div>

        <div class="col-md-12">
                <div class="float-right">
                <div class="btn-group btn-group-sm float-right mb-3" role="group" aria-label="">
                    <a class="btn btn-primary" href="{% url 'invoice:as_pdf' record.id %}"><i class="fa fa-download"></i>&nbsp;Download PDF</a> 
                    <a class="btn btn-info" onClick="do_action('send_email', '{{record.id}}')" href="#"><i class="fa fa-envelope"></i>&nbsp;Send Email</a> 
                </div>
            </div>
        </div>

        <div class="col-md-12 col-sm-12">
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a class="nav-link active" data-toggle="tab" href="#details">Details</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#line_items">Line Items</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#notes">Notes</a>
                </li>
            </ul>

            <script>

                var tbl_record_notes;
                jQuery(document).ready(function($) {
        
  tbl_record_notes = $('#record_notes').DataTable(
    {
      dom: 'B<"float-left mt-3 mb-3"l><"float-right mt-3"f><"row clear">rt<"row"<"col-6"i><"col-6 float-right"p>>',
      buttons: [
        {
          extend: 'csv', className: 'btn btn-sm btn-primary text-white text-light',
          text: '<i class="fas fa-file-csv text-white"></i>&nbsp;CSV',
          titleAttr: 'Export results to CSV'
        },
        {
          extend: 'print', className: 'btn btn-sm btn-primary text-white text-light',
          text: '<i class="fas fa-print text-white"></i>&nbsp;Print',
          titleAttr: 'Print'
        },
      ],
      'lengthMenu': [30, 50, 100],
      'order': [[0, 'desc']],
      'columns': [
        {
          'searchable': false,
        },
        {
          'render': function (data, type, row, meta) {
            let note = row.note            
            return note
          }
        },
        
        {
          'render': function (data, type, row, meta) {
            return row.createdby.last_name + ", " +
              row.createdby.first_name
          }
        },
        {
          'orderable': false,
          'searchable': false,
          'render': function (data, type, row, meta) {
            return '';
            return '<a href="#notes" data-id="' + row.id + '" class="delete_student_note btn btn-sm btn-danger"><i class="fa fa-trash"></i></a>';
          }
        }
      ]
    }
  );
                    $('form.frm_ajax').submit(function(event) {

                        var blocked_element = $(this).parent()
                        $(blocked_element).block();
                        event.preventDefault()

                        form = $(this)

                        if($("input, select, textarea").hasClass('is-invalid'))
                            $("input, select, textarea").removeClass('is-invalid')
                        
                        if($("input, select, textarea").next('p').length) 
                            $("input, select, textarea").nextAll('p').empty();

                        let action = $(form).attr('action')
                        let first_element = '';
                        
                        $.post({
                            url: action,
                            data: $(form).serialize(),
                            error: function(xhr, status, error) {

                                let errors = $.parseJSON(xhr.responseJSON.errors);
                                
                                for (var name in errors) {
                                    for (var i in errors[name]) {
                                        var $input = $("[name='"+ name +"']");
                                        $input.addClass('is-invalid');

                                        $input.after("<p class='invalid-feedback'><strong class=''>" + errors[name][i].message + "</strong></p>");
                                    }

                                    if(first_element == '')
                                        $input.focus()
                                    else {
                                        first_element = '-'
                                    }
                                }

                                var span = document.createElement('span')
                                span.innerHTML = xhr.responseJSON.message
                                swal({
                                    title: xhr.responseJSON.message,
                                    content: span,
                                    icon: 'warning'
                                });

                                $(blocked_element).unblock();
                            },
                            success: function(response) {
                                swal({
                                    title: 'Success',
                                    text: response.message,
                                    icon: response.status
                                }).then(
                                    (value) => {
                                        if(response.action == 'reload')
                                            location.reload();
                                    }
                                )
                                $(blocked_element).unblock();
                            }
                        })
                        return false
                    });
                });
            </script>

            {% if messages %}
            <ul class="messages list-group m-2">
                {% for message in messages %}
                <li{% if message.tags %} class="list-group-item {{ message.tags }}" {% endif %}>
                    {{ message }}</li>
                    {% endfor %}
            </ul>
            {% endif %}

            <!-- Tab panes -->
            <div class="tab-content">
                
                <div class="tab-pane" id="notes">                    
                    <div class="row">
                        <div class="col-12 bg-gray-100">
                            <div class="card mb-4 border-top-0">
                                <div class="card-body ">
                                    <div class="text-right">
                                        <a href="#notes" onClick="do_action('add_new_note', '{{record.id}}')" class="btn btn-sm btn-primary ajax-add_new"
                                            ><i
                                                class="fa fas-light fa-plus-circle"></i>&nbsp;Add New Note</a>
                                    </div>
                                    <div class="clearfix">&nbsp;</div>
                                    <div class="table-responsive">
                                        <table style="width: 100%;" id="record_notes" class="table table-striped responsive"
                                            style="width:100%" data-server-side="true" data-ajax="{{notes_api_url}}">
                                            <thead>
                                                <tr>
                                                    <th data-data="createdon" data-name="createdon">Added On
                                                    </th>
                                                    <th data-data="note" data-name="note">Note
                                                    </th>
                                                    <th data-data="createdby.last_name" data-name="createdby.last_name">
                                                        Added By
                                                    </th>
                                                    <th data-data="id" data-name="id"></th>
                                                </tr>
                                            </thead>
                                        </table>
                                    </div> <!-- end table-responsive -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div> <!-- end #notes -->

                <div class="tab-pane" id="line_items">
                    <div class="card border-top-0">
                        <div class="card-body">
                            <script>
                                var table;
                                setInterval(function() {
            
                                    if(!table.rows('.selected').any())
                                        table.ajax.reload(null, false);
                                }, 10000 * 60);
                                

    window.refreshTable = function () {
        var selectedRows = table.rows({ selected: true });

        selectedRows.deselect();

        table.ajax.reload(null, false);
        tbl_record_notes.ajax.reload(null, false);
    };

                                $(document).ready(function () {
            
                                    let baseURL = '{{api_url}}'
            
                                    $(document).on("click", "form.filter #id_btn_filter", function () {
                                        load_data();
                                    })
            
                                    function load_data() {
                                        let form = $('form.filter')
                                        let newURL = baseURL + '&' + $(form).serialize();
            
                                        table.ajax.url(newURL).load()
                                    }
            
                                    table = $('#records_all')
                                        .DataTable({
                                            initComplete: function () {
                                                this.api()
                                                    .columns()
                                                    .every(function () {
                                                        let column = this;
                                                        let title = column.footer().textContent;
                                        
                                                        // Create input element
                                                        if(title != '') {
                                                            let input = document.createElement('input');
                                                            input.className = 'form-control'
                                                            input.placeholder = "Search " + title;
            
                                                            column.footer().replaceChildren(input);
                                            
                                                            // Event listener for user input
                                                            input
                                                            .addEventListener('keyup', $.debounce(1500,() => {
                                                                if (column.search() !== this.value) {
                                                                    column.search(input.value).draw();
                                                                }
                                                            }));
                                                        }
                                                    });
            
            
                                                // Restore state
                                                var state = this.api().state.loaded();
                                                if (state) {
                                                    this.api().columns().eq(0).each(function (colIdx) {
                                                        var colSearch = state.columns[colIdx].search;
            
                                                        if (colSearch.search) {
                                                            $('input', this.column(colIdx).footer()).val(colSearch.search);
                                                        }
                                                    });
                                                }
                                            },
                                            searchDelay: 1500,
                                            columnDefs: [
                                                {
                                                    orderable: false,
                                                    className: 'select-checkbox',
                                                    targets: 0
                                                }
                                            ],
                                            select: {
                                                style: 'os',
                                                selector: 'td:first-child'
                                            },
                                            rowId: 'id',
                                            dom: 'B<"float-left mt-3 mb-3"l><"float-right mt-3"f><"row clear">rt<"row"<"col-6"i><"col-6 float-right"p>>',
                                            buttons: [
                                                {
                                                    extend: 'csv', className: 'btn btn-sm btn-primary text-white text-light',
                                                    text: '<i class="fas fa-file-csv text-white"></i>&nbsp;CSV',
                                                    titleAttr: 'Export Records in current View to CSV' 
                                                },
                                                { 
                                                    extend: 'print', className: 'btn btn-sm btn-primary text-white text-light',
                                                    text: '<i class="fas fa-print text-white"></i>&nbsp;Print',
                                                    titleAttr: 'Print Records in Current View' 
                                                },
                                                {
                                                    className: 'btn btn-sm btn-primary text-white text-light',
                                                    text: '<i class="fas fa-plus text-white"></i>&nbsp;Add New Item',
                                                    titleAttr: 'Add New Item',
                                                    action: function ( e, dt, node, config ) {
                                                        do_action('add_new_item', '{{record.id}}')
                                                    }
                                                },
                                            ],
                                            'orderCellsTop': true,
                                            'fixedHeader': true,
                                            // searching: false,
                                            ajax: '{{api_url}}',
                                            serverSide: true,
                                            processing: true,
                                            order: [[1, 'desc']],
                                            // stateSave: true,
                                            language: {
                                                'loadingRecords': '&nbsp;',
                                            },
                                            'lengthMenu': [30, 50, 100],
            
                                            'columns': [
                                                {
                                                    'searchable': false,
                                                    'orderable': false,
                                                    'render': function (data, type, row, meta) {
                                                        return ''
                                                    }
                                                },
                                                null,
                                                null,

                                                {
                                                    'searchable': false,
                                                    'orderable': false,
                                                    'render': function (data, type, row, meta) {
                                                        return "<a class='btn btn-sm btn-primary' onClick=\"do_action('edit_line_item', '" + row.id + "')\" href='#'>Edit/View Details</a>"
                                                    }
                                                }
                                            ]
                                        }
                                    );


                                });

                                function do_action(action, id) {

                                    let data = {
                                        'action': action,
                                        'ids': Array()
                                    }
                                    data.ids.push(id)

                                    url = "{%url 'invoice:bulk_action' %}"
                                    let modal = "modal-bulk_actions"

                                    $.ajax({
                                        type: "GET",
                                        url: url,
                                        data: data,
                                        success: function(response) {
                                            $("#bulk_modal_content").html(response);
                                            $("#" + modal).modal('show');
                                        }
                                    });
                                }
                            </script>
                            <table id="records_all" class="table dataTable table-striped responsive"
                                    style="width:100%" data-server-side="true" data-ajax="{{api_url}}">
                                    <thead>
                                        <tr>
                                            <th></th>
                                            <th data-data="description" data-name="description">Description
                                            </th>
                                            <th data-data="formatted_amount" searchable="1" data-name="amount">Amount
                                            </th>
                                            <th data-data="id" data-name='id'><span class="sr-only">Actions</span></th>
                                        </tr>
                                    </thead>
                                    <tfoot>
                                        <th></th>
                                        <th>Description</th>
                                        <th>Amount</th>
                                        <th></th>
                                    </tfoot>
                                </table>
                        </div>
                    </div>
                </div>

                <div class="tab-pane active" id="details">
                    <div class="bg-white border border-top-0">
                        <div class="col-12 pt-3 mb-3">
                            <div class="">
                                <div class="">
                                    <div class="">
                                        <script>
                                            jQuery(document).ready(function($) {
                                                $("input.delete").on("click", function() {
                                                    if(!confirm("Are you sure you want to permanently delete this record and all associated data?"))
                                                        return;
                                                    
                                                        $.ajax({
                                                        type: 'GET',
                                                        url: "{% url 'invoice:delete_invoice' record.id%}",
                                                        success: function (response) {
                                                            $.unblockUI();
                                                            swal({
                                                                title: 'Success',
                                                                text: response.message,
                                                                icon: response.status
                                                            }).then(
                                                                (value) => {
                                                                    if(window.frameElement !== null) {
                                                                        window.parent.closeModal()
                                                                    } else {
                                                                        window.location = "{% url 'invoice:all' %}";
                                                                    }
                                                                }
                                                            )
                                                        }
                                                    });
                                                });
                                            });
                                        </script>
                                        {{form.media}}
                                        <form action="" method="post" class="frm_ajax">
                                            {% csrf_token %}
                                            {{ form | crispy }}
                                            <input type="submit" class="btn btn-primary btn-sm" value="Update">&nbsp;
                                            <input type="button" value="Delete" class="btn btn-danger btn-sm delete float-right pull-right">
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- end tab #details -->

            </div>
        </div>
    </div>
</main>
{%endblock%}